<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>â¤å½¬å½¬ç»™é¹é¹çš„ä¸“å±æƒ…ä¹¦â¤</title>
    <link type="text/css" rel="stylesheet" href="./Love_files/default.css">
    <script type="text/javascript" src="./Love_files/jquery.min.js"></script>
    <script type="text/javascript" src="./Love_files/jscex.min.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-parser.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-jit.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-builderbase.min.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-async.min.js"></script>
    <script type="text/javascript" src="./Love_files/jscex-async-powerpack.min.js"></script>
    <script type="text/javascript" src="./Love_files/functions.js" charset="utf-8"></script>
    <style>
        /* åŸºç¡€é‡ç½® */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Microsoft YaHei', 'Arial', sans-serif;
            background: #ffe6f2;
            min-height: 100vh;
            overflow-x: hidden;
            position: relative;
        }
        
        /* æµ®åŠ¨çˆ±å¿ƒèƒŒæ™¯ */
        .floating-hearts {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 1;
        }
        
        .floating-heart {
            position: absolute;
            color: rgba(255, 182, 193, 0.6);
            font-size: 20px;
            animation: float 20s infinite linear;
        }
        
        @keyframes float {
            0% {
                transform: translateY(100vh) rotate(0deg);
                opacity: 0;
            }
            10% {
                opacity: 0.8;
            }
            90% {
                opacity: 0.8;
            }
            100% {
                transform: translateY(-100px) rotate(360deg);
                opacity: 0;
            }
        }
        
        /* ç‚¹å‡»ç§å­é¡µé¢ */
        .seed-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #ffc8dd, #ffafcc, #ffc8dd);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            cursor: pointer;
            transition: opacity 1s ease;
        }
        
        .seed-container.hidden {
            opacity: 0;
            pointer-events: none;
        }
        
        .seed-message {
            text-align: center;
            color: white;
            padding: 30px;
            background: rgba(233, 30, 99, 0.9);
            border-radius: 20px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.3);
            animation: pulse 2s infinite;
            max-width: 90%;
            margin: 0 auto;
        }
        
        .seed-message h2 {
            font-size: 28px;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }
        
        .seed-message p {
            font-size: 18px;
            margin: 10px 0;
            line-height: 1.5;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }
        
        /* ä¸»å®¹å™¨ */
        #main {
            width: 100%;
            min-height: 100vh;
            position: relative;
            z-index: 2;
            display: none;
            background: rgba(255, 255, 255, 0.95);
        }
        
        /* æƒ…ä¹¦åŒºåŸŸ */
        #wrap {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
            position: relative;
            z-index: 3;
        }
        
        #text {
            background: rgba(255, 250, 252, 0.95);
            border-radius: 20px;
            padding: 25px;
            margin: 20px 0;
            box-shadow: 0 10px 30px rgba(255, 64, 129, 0.15);
            border: 2px solid #ffc8dd;
            backdrop-filter: blur(10px);
        }
        
        .main-title {
            text-align: center;
            color: #e91e63;
            font-size: 28px;
            margin-bottom: 25px;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.1);
            position: relative;
            padding-bottom: 15px;
        }
        
        .main-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 4px;
            background: linear-gradient(90deg, #ffc8dd, #e91e63, #ffc8dd);
            border-radius: 2px;
        }
        
        .say {
            display: block;
            font-size: 18px;
            line-height: 1.8;
            color: #333;
            margin-bottom: 15px;
            padding-left: 10px;
            border-left: 3px solid #ffc8dd;
            animation: fadeInUp 0.5s ease forwards;
            opacity: 0;
        }
        
        @keyframes fadeInUp {
            to {
                opacity: 1;
                transform: translateY(0);
            }
            from {
                transform: translateY(10px);
            }
        }
        
        .duration-placeholder {
            color: #ff4081;
            font-weight: bold;
            background: rgba(255, 200, 221, 0.3);
            padding: 2px 8px;
            border-radius: 5px;
            border: 1px dashed #ff4081;
            animation: pulse 2s infinite;
        }
        
        /* çˆ±æƒ…çºªå¿µå†Œ */
        .love-album {
            background: white;
            border-radius: 20px;
            padding: 25px;
            margin: 25px 0;
            box-shadow: 0 15px 35px rgba(255, 64, 129, 0.2);
            border: 3px solid #ffc8dd;
            display: none;
            opacity: 0;
            transform: translateY(30px);
            transition: all 1s ease;
        }
        
        .love-album.show {
            display: block;
            opacity: 1;
            transform: translateY(0);
        }
        
        .love-album h3 {
            text-align: center;
            color: #e91e63;
            font-size: 24px;
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 15px;
        }
        
        .love-album h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, #ffc8dd, #e91e63, #ffc8dd);
            border-radius: 2px;
        }
        
        .romantic-date {
            font-size: 18px;
            color: #333;
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: linear-gradient(135deg, #fff5f7, #ffe4e9);
            border-radius: 12px;
            border: 2px solid #ffc8dd;
        }
        
        .heart-icon {
            color: #ff4081;
            font-size: 20px;
            margin: 0 8px;
            animation: heartbeat 1.5s infinite;
        }
        
        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.2); }
        }
        
        .love-metric {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin: 20px 0;
            justify-content: center;
        }
        
        .metric-box {
            flex: 1;
            min-width: 150px;
            background: linear-gradient(135deg, #fff5f7, #ffe4e9);
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            border: 2px solid #ffc8dd;
            box-shadow: 0 8px 20px rgba(233, 30, 99, 0.15);
            transition: all 0.3s ease;
        }
        
        .metric-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(233, 30, 99, 0.25);
        }
        
        .metric-value {
            font-size: 32px;
            font-weight: bold;
            color: #e91e63;
            margin: 10px 0;
            display: block;
        }
        
        .metric-label {
            font-size: 14px;
            color: #666;
            text-transform: uppercase;
            letter-spacing: 1px;
            font-weight: 600;
        }
        
        .love-note {
            margin-top: 25px;
            font-style: italic;
            color: #666;
            font-size: 16px;
            padding: 20px;
            background: linear-gradient(135deg, #fff, #fff9fb);
            border-radius: 12px;
            border: 2px dashed #ffc8dd;
            line-height: 1.6;
            text-align: center;
        }
        
        .special-day {
            animation: glow 2s infinite alternate;
            color: #ff4081 !important;
            font-weight: bold;
            padding: 8px 15px;
            background: rgba(255, 64, 129, 0.15);
            border-radius: 10px;
            display: inline-block;
            margin: 10px auto;
            text-align: center;
        }
        
        @keyframes glow {
            from { box-shadow: 0 0 10px rgba(255, 64, 129, 0.5); }
            to { box-shadow: 0 0 20px rgba(255, 64, 129, 0.8); }
        }
        
        /* æ—¶é’Ÿç›’å­ */
        #clock-box {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            margin: 20px 0;
            border: 2px solid #ffc8dd;
            box-shadow: 0 10px 25px rgba(255, 64, 129, 0.15);
        }
        
        #clock {
            font-size: 24px;
            color: #e91e63;
            font-weight: bold;
            margin-top: 10px;
            padding: 10px;
            background: linear-gradient(135deg, #fff5f7, #ffe4e9);
            border-radius: 10px;
            display: inline-block;
        }
        
        /* éŸ³ä¹æ§åˆ¶ */
        .music-control {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
            border: 3px solid #ffc8dd;
            display: none;
            opacity: 0;
            transition: all 0.5s ease;
        }
        
        .music-control.show {
            display: flex;
            opacity: 1;
        }
        
        .music-control i {
            color: #e91e63;
            font-size: 28px;
        }
        
        /* ç”»å¸ƒ - æ ‘åŠ¨ç”» */
        #canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2;
            pointer-events: none;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            #wrap {
                padding: 15px;
            }
            
            .seed-message h2 {
                font-size: 24px;
            }
            
            .seed-message p {
                font-size: 16px;
            }
            
            .main-title {
                font-size: 24px;
                margin-bottom: 20px;
            }
            
            .say {
                font-size: 16px;
                margin-bottom: 12px;
            }
            
            #text {
                padding: 20px;
                margin: 15px 0;
            }
            
            .love-album {
                padding: 20px;
                margin: 20px 0;
            }
            
            .love-album h3 {
                font-size: 22px;
            }
            
            .metric-box {
                min-width: 120px;
                padding: 15px;
            }
            
            .metric-value {
                font-size: 28px;
            }
            
            .love-metric {
                gap: 10px;
            }
            
            .romantic-date {
                font-size: 16px;
                padding: 12px;
            }
            
            .love-note {
                font-size: 15px;
                padding: 15px;
            }
            
            #clock-box {
                padding: 15px;
                margin: 15px 0;
            }
            
            #clock {
                font-size: 20px;
                padding: 8px;
            }
            
            .music-control {
                width: 50px;
                height: 50px;
                bottom: 15px;
                right: 15px;
            }
            
            .music-control i {
                font-size: 24px;
            }
        }
        
        @media (max-width: 480px) {
            .seed-message {
                padding: 20px;
            }
            
            .seed-message h2 {
                font-size: 20px;
            }
            
            .seed-message p {
                font-size: 14px;
            }
            
            .main-title {
                font-size: 22px;
            }
            
            .say {
                font-size: 15px;
            }
            
            .love-metric {
                flex-direction: column;
                align-items: center;
            }
            
            .metric-box {
                width: 100%;
                max-width: 250px;
            }
            
            .duration-placeholder {
                font-size: 14px;
            }
        }
        
        /* é”™è¯¯æç¤º */
        #error {
            display: none;
            background: #ffebee;
            color: #c62828;
            padding: 15px;
            border-radius: 10px;
            margin: 20px;
            text-align: center;
            border: 2px solid #ef9a9a;
        }
    </style>
</head>
<body>
    <!-- ç‚¹å‡»ç§å­é¡µé¢ -->
    <div class="seed-container" id="seedContainer">
        <div class="seed-message">
            <h2>â¤ çˆ±çš„ç§å­ â¤</h2>
            <p>ç‚¹å‡»è¿™é¢—ç§å­ï¼Œè®©å®ƒé•¿æˆæˆ‘ä»¬çš„çˆ±æƒ…æ ‘</p>
            <p>å½¬å½¬ â¤ é¹é¹</p>
            <p>ä» 2024å¹´5æœˆ24æ—¥ å¼€å§‹</p>
        </div>
    </div>
    
    <!-- æµ®åŠ¨çˆ±å¿ƒèƒŒæ™¯ -->
    <div class="floating-hearts" id="floatingHearts"></div>
    
    <!-- éŸ³ä¹æ§åˆ¶æŒ‰é’® -->
    <div class="music-control" id="musicControl">
        <i>ğŸµ</i>
    </div>
    
    <!-- ä¸»å†…å®¹ -->
    <div id="main">
        <div id="error">
            äº²ï¼Œæ‚¨ä½¿ç”¨çš„æµè§ˆå™¨æ— æ³•æ”¯æŒå³å°†æ˜¾ç¤ºçš„å†…å®¹<br>
            è¯·æ¢æˆChromeæˆ–Firefoxæµè§ˆå™¨å“Ÿ~
        </div>
        <div id="wrap">
            <!-- æƒ…ä¹¦åŒºåŸŸ -->
            <div id="text">
                <div id="code">
                    <div class="main-title">ä¸€å®šä¼šçˆ±ä½ </div>
                    <span class="say">æˆ‘çŸ¥é“ï¼Œä½ æ˜¯ä¸€ä¸ªå¤©çœŸã€å–„è‰¯åˆæ¸©æŸ”çš„ç”·å­©</span>
                    <span class="say">è¿™æ®µå’Œä½ å¹¶è‚©èµ°è¿‡çš„<span id="duration" class="duration-placeholder">...</span>æ—¶å…‰ï¼Œæ˜¯æˆ‘ç”Ÿå‘½é‡Œæœ€æ˜äº®çš„ç« èŠ‚</span>
                    <span class="say">å¦‚æœä½ æ„¿æ„ï¼Œè®©æˆ‘ç‰µç´§ä½ çš„æ‰‹ï¼Œåœ¨å±äºæˆ‘ä»¬çš„æ•…äº‹é‡Œ</span>
                    <span class="say">å¥½å¥½åœ°ã€å®Œæ•´åœ°å»çˆ±ä¸€æ¬¡</span>
                    <span class="say">æˆ‘çˆ±ä½ ï¼Œçˆ±åˆ°æ˜¼å¤œåœ¨å¯»å¸¸å··é™Œé‡Œä¸ºæˆ‘ä»¬è§è¯</span>
                    <span class="say">çˆ±åˆ°å››å­£æµè½¬éƒ½æˆä¸ºæˆ‘ä»¬ç›¸å®ˆçš„åºç« </span>
                    <span class="say">çˆ±åˆ°æ¯ä¸€ç¼•é£ç»è¿‡ï¼Œéƒ½è®¤å¾—æˆ‘ä¿©å¹¶è‚©çš„èº«å½±</span>
                    <span class="say">çˆ±åˆ°ä¸–ç•Œå®‰é™æ—¶ï¼Œåªå¬å¾—åˆ°å½¼æ­¤çš„å¿ƒè·³</span>
                    <span class="say">æˆ‘çˆ±ä½ ï¼Œçˆ±åˆ°æ—¶é—´å¤±å»åˆ»åº¦ï¼Œæœªæ¥ä¸å¿…åˆ†æ˜</span>
                    <span class="say">çˆ±åˆ°æ— è®ºé‡æ¥å¤šå°‘æ¬¡ï¼Œé€‰æ‹©ä¾ç„¶ä¼šæ˜¯ä½ </span>
                    <span class="say">å°±æŠŠè¿™äº›è¯è¯´ç»™æˆ‘æœ€äº²çˆ±çš„ç”·å­©å¬</span>
                    <span class="say">æ„¿ä»¥çœŸå¿ƒï¼Œæ¢ä½ æˆ‘å¾€åæœæœæš®æš®</span>
                    <span class="say">è®©æˆ‘å¥½å¥½çˆ±ä½ ï¼Œè¡Œå—</span>
                    <span class="say" style="text-align: right; display: block; margin-top: 30px; font-style: italic;">
                        -- æ°¸è¿œçˆ±ä½ çš„å½¬å½¬
                    </span>
                </div>
            </div>
            
            <!-- çˆ±æƒ…çºªå¿µå†Œï¼ˆåŠ¨æ€åˆ›å»ºï¼‰ -->
            <div id="clock-box">
                <span style="color: #e91e63; font-weight: bold;">å½¬å½¬</span> 
                <span class="heart-icon">â¤</span> å’Œ 
                <span class="heart-icon">â¤</span>
                <span style="color: #e91e63; font-weight: bold;">é¹é¹</span> çš„çˆ±æƒ…å†ç¨‹
                <div id="clock"></div>
            </div>
        </div>
    </div>
    
    <!-- æ ‘åŠ¨ç”»ç”»å¸ƒ -->
    <canvas id="canvas" width="1100" height="680"></canvas>

    <!-- èƒŒæ™¯éŸ³ä¹ -->
    <audio preload="auto" id="media" loop="loop">
        <source src="love.mp3" type="audio/mpeg">
    </audio>

    <script>
        // ========== åŠ¨ç”»æ ¸å¿ƒä»£ç  ==========
        (function(window){
            function random(min, max) {
                return min + Math.floor(Math.random() * (max - min + 1));
            }

            function bezier(cp, t) {  
                var p1 = cp[0].mul((1 - t) * (1 - t));
                var p2 = cp[1].mul(2 * t * (1 - t));
                var p3 = cp[2].mul(t * t); 
                return p1.add(p2).add(p3);
            }  

            function inheart(x, y, r) {
                var z = ((x / r) * (x / r) + (y / r) * (y / r) - 1) * ((x / r) * (x / r) + (y / r) * (y / r) - 1) * ((x / r) * (x / r) + (y / r) * (y / r) - 1) - (x / r) * (x / r) * (y / r) * (y / r) * (y / r);
                return z < 0;
            }

            Point = function(x, y) {
                this.x = x || 0;
                this.y = y || 0;
            }
            Point.prototype = {
                clone: function() {
                    return new Point(this.x, this.y);
                },
                add: function(o) {
                    p = this.clone();
                    p.x += o.x;
                    p.y += o.y;
                    return p;
                },
                sub: function(o) {
                    p = this.clone();
                    p.x -= o.x;
                    p.y -= o.y;
                    return p;
                },
                div: function(n) {
                    p = this.clone();
                    p.x /= n;
                    p.y /= n;
                    return p;
                },
                mul: function(n) {
                    p = this.clone();
                    p.x *= n;
                    p.y *= n;
                    return p;
                }
            }

            Heart = function() {
                var points = [], x, y, t;
                for (var i = 10; i < 30; i += 0.2) {
                    t = i / Math.PI;
                    x = 16 * Math.pow(Math.sin(t), 3);
                    y = 13 * Math.cos(t) - 5 * Math.cos(2 * t) - 2 * Math.cos(3 * t) - Math.cos(4 * t);
                    points.push(new Point(x, y));
                }
                this.points = points;
                this.length = points.length;
            }
            Heart.prototype = {
                get: function(i, scale) {
                    return this.points[i].mul(scale || 1);
                }
            }

            Seed = function(tree, point, scale, color) {
                this.tree = tree;
                var scale = scale || 1
                var color = color || '#FF0000';

                this.heart = {
                    point  : point,
                    scale  : scale,
                    color  : color,
                    figure : new Heart(),
                }

                this.cirle = {
                    point  : point,
                    scale  : scale,
                    color  : color,
                    radius : 5,
                }
            }
            Seed.prototype = {
                draw: function() {
                    this.drawHeart();
                    this.drawText();
                },
                addPosition: function(x, y) {
                    this.cirle.point = this.cirle.point.add(new Point(x, y));
                },
                canMove: function() {
                    return this.cirle.point.y < (this.tree.height + 20); 
                },
                move: function(x, y) {
                    this.clear();
                    this.drawCirle();
                    this.addPosition(x, y);
                },
                canScale: function() {
                    return this.heart.scale > 0.2;
                },
                setHeartScale: function(scale) {
                    this.heart.scale *= scale;
                },
                scale: function(scale) {
                    this.clear();
                    this.drawCirle();
                    this.drawHeart();
                    this.setHeartScale(scale);
                },
                drawHeart: function() {
                    var ctx = this.tree.ctx, heart = this.heart;
                    var point = heart.point, color = heart.color, scale = heart.scale;
                    ctx.save();
                    ctx.fillStyle = color;
                    ctx.translate(point.x, point.y);
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    for (var i = 0; i < heart.figure.length; i++) {
                        var p = heart.figure.get(i, scale);
                        ctx.lineTo(p.x, -p.y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                },
                drawCirle: function() {
                    var ctx = this.tree.ctx, cirle = this.cirle;
                    var point = cirle.point, color = cirle.color, scale = cirle.scale, radius = cirle.radius;
                    ctx.save();
                    ctx.fillStyle = color;
                    ctx.translate(point.x, point.y);
                    ctx.scale(scale, scale);
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.arc(0, 0, radius, 0, 2 * Math.PI);
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                },
                drawText: function() {
                    var ctx = this.tree.ctx, heart = this.heart;
                    var point = heart.point, color = heart.color, scale = heart.scale;
                    ctx.save();
                    ctx.strokeStyle = color;
                    ctx.fillStyle = color;
                    ctx.translate(point.x, point.y);
                    ctx.scale(scale, scale);
                    ctx.moveTo(0, 0);
                    ctx.lineTo(15, 15);
                    ctx.lineTo(60, 15);
                    ctx.stroke();

                    ctx.moveTo(0, 0);
                    ctx.scale(0.75, 0.75);
                    ctx.font = "12px Microsoft YaHei, Arial";
                    ctx.fillText("ç‚¹å‡»å¼€å§‹", 23, 16);
                    ctx.restore();
                },
                clear: function() {
                    var ctx = this.tree.ctx, cirle = this.cirle;
                    var point = cirle.point, scale = cirle.scale, radius = 26;
                    var w = h = (radius * scale);
                    ctx.clearRect(point.x - w, point.y - h, 4 * w, 4 * h);
                },
                hover: function(x, y) {
                    var ctx = this.tree.ctx;
                    var pixel = ctx.getImageData(x, y, 1, 1);
                    return pixel.data[3] == 255
                }
            }

            Footer = function(tree, width, height, speed) {
                this.tree = tree;
                this.point = new Point(tree.seed.heart.point.x, tree.height - height / 2);
                this.width = width;
                this.height = height;
                this.speed = speed || 2;
                this.length = 0;
            }
            Footer.prototype = {
                draw: function() {
                    var ctx = this.tree.ctx, point = this.point;
                    var len = this.length / 2;

                    ctx.save();
                    ctx.strokeStyle = 'rgb(35, 31, 32)';
                    ctx.lineWidth = this.height;
                    ctx.lineCap = 'round';
                    ctx.lineJoin = 'round';
                    ctx.translate(point.x, point.y);
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    ctx.lineTo(len, 0);
                    ctx.lineTo(-len, 0);
                    ctx.stroke();
                    ctx.restore();

                    if (this.length < this.width) {
                        this.length += this.speed;
                    }
                }
            }

            Tree = function(canvas, width, height, opt) {
                this.canvas = canvas;
                this.ctx = canvas.getContext('2d');
                this.width = width;
                this.height = height;
                this.opt = opt || {};

                this.record = {};
                
                this.initSeed();
                this.initFooter();
                this.initBranch();
                this.initBloom();
            }
            Tree.prototype = {
                initSeed: function() {
                    var seed = this.opt.seed || {};
                    var x = seed.x || this.width / 2;
                    var y = seed.y || this.height / 2;
                    var point = new Point(x, y);
                    var color = seed.color || '#FF0000';
                    var scale = seed.scale || 1;

                    this.seed = new Seed(this, point, scale, color);
                },

                initFooter: function() {
                    var footer = this.opt.footer || {};
                    var width = footer.width || this.width;
                    var height = footer.height || 5;
                    var speed = footer.speed || 2;
                    this.footer = new Footer(this, width, height, speed);
                },

                initBranch: function() {
                    var branchs = this.opt.branch || []
                    this.branchs = [];
                    this.addBranchs(branchs);
                },

                initBloom: function() {
                    var bloom = this.opt.bloom || {};
                    var cache = [],
                        num = bloom.num || 500, 
                        width = bloom.width || this.width,
                        height = bloom.height || this.height,
                        figure = this.seed.heart.figure;
                    var r = 240, x, y;
                    for (var i = 0; i < num; i++) {
                        cache.push(this.createBloom(width, height, r, figure));
                    }
                    this.blooms = [];
                    this.bloomsCache = cache;
                },

                toDataURL: function(type) {
                    return this.canvas.toDataURL(type);
                },

                draw: function(k) {
                    var s = this, ctx = s.ctx;
                    var rec = s.record[k];
                    if (!rec) {
                        return ;
                    }
                    var point = rec.point,
                        image = rec.image;

                    ctx.save();
                    ctx.putImageData(image, point.x, point.y);
                    ctx.restore();
                },

                addBranch: function(branch) {
                    this.branchs.push(branch);
                },

                addBranchs: function(branchs){
                    var s = this, b, p1, p2, p3, r, l, c;
                    for (var i = 0; i < branchs.length; i++) {
                        b = branchs[i];
                        p1 = new Point(b[0], b[1]);
                        p2 = new Point(b[2], b[3]);
                        p3 = new Point(b[4], b[5]);
                        r = b[6];
                        l = b[7];
                        c = b[8]
                        s.addBranch(new Branch(s, p1, p2, p3, r, l, c)); 
                    }
                },

                removeBranch: function(branch) {
                    var branchs = this.branchs;
                    for (var i = 0; i < branchs.length; i++) {
                        if (branchs[i] === branch) {
                            branchs.splice(i, 1);
                        }
                    }
                },

                canGrow: function() {
                    return !!this.branchs.length;
                },
                grow: function() {
                    var branchs = this.branchs;
                    for (var i = 0; i < branchs.length; i++) {
                        var branch = branchs[i];
                        if (branch) {
                            branch.grow();
                        }
                    }
                },

                addBloom: function (bloom) {
                    this.blooms.push(bloom);
                },

                removeBloom: function (bloom) {
                    var blooms = this.blooms;
                    for (var i = 0; i < blooms.length; i++) {
                        if (blooms[i] === bloom) {
                            blooms.splice(i, 1);
                        }
                    }
                },

                createBloom: function(width, height, radius, figure, color, alpha, angle, scale, place, speed) {
                    var x, y;
                    while (true) {
                        x = random(20, width - 20);
                        y = random(20, height - 20);
                        if (inheart(x - width / 2, height - (height - 40) / 2 - y, radius)) {
                            return new Bloom(this, new Point(x, y), figure, color, alpha, angle, scale, place, speed);
                        }
                    }
                },
                
                canFlower: function() {
                    return !!this.blooms.length;
                }, 
                flower: function(num) {
                    var s = this, blooms = s.bloomsCache.splice(0, num);
                    for (var i = 0; i < blooms.length; i++) {
                        s.addBloom(blooms[i]);
                    }
                    blooms = s.blooms;
                    for (var j = 0; j < blooms.length; j++) {
                        blooms[j].flower();
                    }
                },

                snapshot: function(k, x, y, width, height) {
                    var ctx = this.ctx;
                    var image = ctx.getImageData(x, y, width, height); 
                    this.record[k] = {
                        image: image,
                        point: new Point(x, y),
                        width: width,
                        height: height
                    }
                },
                setSpeed: function(k, speed) {
                    this.record[k || "move"].speed = speed;
                },
                move: function(k, x, y) {
                    var s = this, ctx = s.ctx;
                    var rec = s.record[k || "move"];
                    var point = rec.point,
                        image = rec.image,
                        speed = rec.speed || 10,
                        width = rec.width,
                        height = rec.height; 

                    i = point.x + speed < x ? point.x + speed : x;
                    j = point.y + speed < y ? point.y + speed : y; 

                    ctx.save();
                    ctx.clearRect(point.x, point.y, width, height);
                    ctx.putImageData(image, i, j);
                    ctx.restore();

                    rec.point = new Point(i, j);
                    rec.speed = speed * 0.95;

                    if (rec.speed < 2) {
                        rec.speed = 2;
                    }
                    return i < x || j < y;
                },

                jump: function() {
                    var s = this, blooms = s.blooms;
                    if (blooms.length) {
                        for (var i = 0; i < blooms.length; i++) {
                            blooms[i].jump();
                        }
                    } 
                    if ((blooms.length && blooms.length < 3) || !blooms.length) {
                        var bloom = this.opt.bloom || {},
                            width = bloom.width || this.width,
                            height = bloom.height || this.height,
                            figure = this.seed.heart.figure;
                        var r = 240, x, y;
                        for (var i = 0; i < random(1,2); i++) {
                            blooms.push(this.createBloom(width / 2 + width, height, r, figure, null, 1, null, 1, new Point(random(-100,600), 720), random(200,300)));
                        }
                    }
                }
            }

            Branch = function(tree, point1, point2, point3, radius, length, branchs) {
                this.tree = tree;
                this.point1 = point1;
                this.point2 = point2;
                this.point3 = point3;
                this.radius = radius;
                this.length = length || 100;    
                this.len = 0;
                this.t = 1 / (this.length - 1);   
                this.branchs = branchs || [];
            }

            Branch.prototype = {
                grow: function() {
                    var s = this, p; 
                    if (s.len <= s.length) {
                        p = bezier([s.point1, s.point2, s.point3], s.len * s.t);
                        s.draw(p);
                        s.len += 1;
                        s.radius *= 0.97;
                    } else {
                        s.tree.removeBranch(s);
                        s.tree.addBranchs(s.branchs);
                    }
                },
                draw: function(p) {
                    var s = this;
                    var ctx = s.tree.ctx;
                    ctx.save();
                    ctx.beginPath();
                    ctx.fillStyle = 'RGB(0,128,128)';
                    ctx.shadowColor = '#22b822';
                    ctx.shadowBlur = 2;
                    ctx.moveTo(p.x, p.y);
                    ctx.arc(p.x, p.y, s.radius, 0, 2 * Math.PI);
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                }
            }

            Bloom = function(tree, point, figure, color, alpha, angle, scale, place, speed) {
                this.tree = tree;
                this.point = point;
                this.color = color || 'rgb(255,' + random(0, 255) + ',' + random(0, 255) + ')';
                this.alpha = alpha || random(0.3, 1);
                this.angle = angle || random(0, 360);
                this.scale = scale || 0.1;
                this.place = place;
                this.speed = speed;

                this.figure = figure;
            }
            Bloom.prototype = {
                setFigure: function(figure) {
                    this.figure = figure;
                },
                flower: function() {
                    var s = this;
                    s.draw();
                    s.scale += 0.1;
                    if (s.scale > 1) {
                        s.tree.removeBloom(s);
                    }
                },
                draw: function() {
                    var s = this, ctx = s.tree.ctx, figure = s.figure;

                    ctx.save();
                    ctx.fillStyle = s.color;
                    ctx.globalAlpha = s.alpha;
                    ctx.translate(s.point.x, s.point.y);
                    ctx.scale(s.scale, s.scale);
                    ctx.rotate(s.angle);
                    ctx.beginPath();
                    ctx.moveTo(0, 0);
                    for (var i = 0; i < figure.length; i++) {
                        var p = figure.get(i);
                        ctx.lineTo(p.x, -p.y);
                    }
                    ctx.closePath();
                    ctx.fill();
                    ctx.restore();
                },
                jump: function() {
                    var s = this, height = s.tree.height;

                    if (s.point.x < -20 || s.point.y > height + 20) {
                        s.tree.removeBloom(s);
                    } else {
                        s.draw();
                        s.point = s.place.sub(s.point).div(s.speed).add(s.point);
                        s.angle += 0.05;
                        s.speed -= 1;
                    }
                }
            }

            window.random = random;
            window.bezier = bezier;
            window.Point = Point;
            window.Tree = Tree;

        })(window);
        // ========== åŠ¨ç”»æ ¸å¿ƒä»£ç ç»“æŸ ==========

        // ========== é¡µé¢é€»è¾‘ä»£ç  ==========
        const startDate = new Date('2024-05-24');
        let animationStarted = false;
        const audio = document.getElementById('media');
        const musicControl = document.getElementById('musicControl');
        
        // åˆ›å»ºæµ®åŠ¨çˆ±å¿ƒ
        function createFloatingHearts() {
            const heartsContainer = document.getElementById('floatingHearts');
            const heartCount = 30;
            
            for (let i = 0; i < heartCount; i++) {
                const heart = document.createElement('div');
                heart.className = 'floating-heart';
                heart.innerHTML = 'â¤';
                heart.style.left = Math.random() * 100 + '%';
                heart.style.fontSize = (Math.random() * 15 + 15) + 'px';
                heart.style.animationDelay = Math.random() * 20 + 's';
                heart.style.animationDuration = (Math.random() * 10 + 20) + 's';
                heart.style.color = `rgba(255, ${Math.random() * 100 + 64}, ${Math.random() * 100 + 129}, ${Math.random() * 0.3 + 0.3})`;
                heartsContainer.appendChild(heart);
            }
        }
        
        // è®¡ç®—æµªæ¼«æ—¶é—´
        function calculateRomanticDuration() {
            const now = new Date();
            const diffTime = Math.abs(now - startDate);
            const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return "åˆšåˆšå¼€å§‹çš„ç¾å¥½";
            if (diffDays === 1) return "ç”œèœœçš„ç¬¬ä¸€å¤©";
            if (diffDays < 7) return diffDays + "ä¸ªç”œèœœæ—¥å¤œ";
            if (diffDays < 30) {
                const weeks = Math.floor(diffDays / 7);
                return weeks + "å‘¨çš„ç¾å¥½æ—¶å…‰";
            }
            if (diffDays < 365) {
                const months = Math.floor(diffDays / 30);
                const days = diffDays % 30;
                return months + "ä¸ªæœˆ" + (days > 0 ? days + "å¤©" : "") + "çš„é™ªä¼´";
            }
            const years = Math.floor(diffDays / 365);
            const months = Math.floor((diffDays % 365) / 30);
            return years + "å¹´" + (months > 0 ? months + "ä¸ªæœˆ" : "") + "çš„æ°¸æ’ä¹‹çº¦";
        }
        
        function calculateTogetherDays() {
            const now = new Date();
            const diffTime = Math.abs(now - startDate);
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }
        
        function calculateNextHundredDays() {
            const togetherDays = calculateTogetherDays();
            const nextHundred = Math.ceil((togetherDays + 1) / 100) * 100;
            return nextHundred - togetherDays;
        }
        
        function isSpecialDay() {
            const togetherDays = calculateTogetherDays();
            if (togetherDays % 100 === 0 && togetherDays > 0) {
                return "ğŸ‰ ä»Šå¤©æ˜¯æˆ‘ä»¬ç¬¬" + togetherDays + "å¤©çºªå¿µæ—¥ï¼";
            }
            if (togetherDays % 365 === 0 && togetherDays > 0) {
                return "ğŸ‰ ä»Šå¤©æ˜¯æˆ‘ä»¬" + (togetherDays / 365) + "å‘¨å¹´çºªå¿µï¼";
            }
            if (togetherDays % 30 === 0 && togetherDays > 0) {
                return "âœ¨ ä»Šå¤©æ­£å¥½æ˜¯æˆ‘ä»¬ç›¸è¯†" + (togetherDays / 30) + "ä¸ªæœˆï¼";
            }
            return null;
        }
        
        // åˆ›å»ºçˆ±æƒ…çºªå¿µå†Œ
        function createLoveAlbum() {
            const clockBox = document.getElementById('clock-box');
            
            const albumHTML = `
                <div class="love-album">
                    <h3>â¤ æˆ‘ä»¬çš„çˆ±æƒ…çºªå¿µå†Œ â¤</h3>
                    
                    <div class="romantic-date">
                        <span class="heart-icon">â¤</span>
                        ä»Šå¤©æ˜¯ï¼š<strong>${new Date().toLocaleDateString('zh-CN', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric', 
                            weekday: 'long' 
                        })}</strong>
                        <span class="heart-icon">â¤</span>
                    </div>
                    
                    <div class="love-metric">
                        <div class="metric-box">
                            <span class="metric-label">åœ¨ä¸€èµ·å¤©æ•°</span>
                            <span class="metric-value">${calculateTogetherDays()}</span>
                            <span class="heart-icon">â¤</span>
                        </div>
                        
                        <div class="metric-box">
                            <span class="metric-label">ä¸‹ä¸ªçºªå¿µæ—¥</span>
                            <span class="metric-value">${calculateNextHundredDays()}</span>
                            <span class="metric-label">å¤©å</span>
                        </div>
                        
                        <div class="metric-box">
                            <span class="metric-label">çˆ±æƒ…æ¸©åº¦</span>
                            <span class="metric-value">100Â°</span>
                            <span class="heart-icon">â™¥</span>
                        </div>
                    </div>
                    
                    <div class="love-note">
                        ä» <strong style="color: #e91e63;">${startDate.toLocaleDateString('zh-CN', { 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        })}</strong> å¼€å§‹ï¼Œ
                        æ¯ä¸€åˆ†æ¯ä¸€ç§’ï¼Œçˆ±ä½ éƒ½åœ¨åŠ æ·±ä¸€åˆ† ğŸ’•<br><br>
                        æˆ‘ä»¬çš„æ•…äº‹ï¼Œæ°¸è¿œæ²¡æœ‰ç»“å°¾...
                    </div>
                    
                    ${getSpecialDayMessage()}
                </div>
            `;
            
            clockBox.insertAdjacentHTML('beforebegin', albumHTML);
            
            setTimeout(() => {
                document.querySelector('.love-album').classList.add('show');
            }, 100);
        }
        
        function getSpecialDayMessage() {
            const specialDay = isSpecialDay();
            if (specialDay) {
                return `<div class="special-day">${specialDay}</div>`;
            }
            return '';
        }
        
        // å¼€å§‹ä½“éªŒ
        function startExperience() {
            if (animationStarted) return;
            animationStarted = true;
            
            const seedContainer = document.getElementById('seedContainer');
            const mainContent = document.getElementById('main');
            
            // æ·¡å‡ºç§å­
            seedContainer.classList.add('hidden');
            
            // æ’­æ”¾éŸ³ä¹
            audio.volume = 0.5;
            audio.play().then(() => {
                musicControl.classList.add('show');
            }).catch(() => {
                musicControl.classList.add('show');
            });
            
            // æ˜¾ç¤ºä¸»å†…å®¹
            setTimeout(() => {
                seedContainer.style.display = 'none';
                mainContent.style.display = 'block';
                
                // æ›´æ–°æƒ…ä¹¦æ—¶é—´
                document.getElementById('duration').textContent = calculateRomanticDuration();
                
                // å¼€å§‹æ ‘åŠ¨ç”»
                startTreeAnimation();
                
                // 3ç§’åæ˜¾ç¤ºæƒ…ä¹¦æ‰“å­—æ•ˆæœ
                setTimeout(() => {
                    const textElement = document.getElementById('text');
                    textElement.style.opacity = '1';
                    
                    // æ¨¡æ‹Ÿæ‰“å­—æ•ˆæœ
                    const says = document.querySelectorAll('.say');
                    says.forEach((say, index) => {
                        setTimeout(() => {
                            say.style.opacity = '1';
                            say.style.transform = 'translateY(0)';
                        }, index * 300);
                    });
                    
                    // 10ç§’åæ˜¾ç¤ºçºªå¿µå†Œ
                    setTimeout(createLoveAlbum, 10000);
                }, 3000);
                
            }, 1000);
        }
        
        // æ ‘åŠ¨ç”»
        function startTreeAnimation() {
            var canvas = document.getElementById('canvas');
            var width = window.innerWidth;
            var height = window.innerHeight;
            
            canvas.width = width;
            canvas.height = height;
            
            var opts = {
                seed: {
                    x: width / 2,
                    color: "rgb(190, 26, 37)",
                    scale: Math.min(width / 550, 2)
                },
                branch: [
                    [width/2-35, height, width/2-30, height/2, width/2-100, height/3, 30, 100, [
                        [width/2-40, height*0.7, width/2-145, height*0.6, width/2-160, height*0.4, 13, 100, [
                            [width/2-50, height*0.64, width/2-66, height*0.63, width/2-106, height*0.58, 2, 40]
                        ]],
                        [width/2-30, height*0.65, width/2, height*0.52, width/2+80, height*0.51, 12, 100, [
                            [width/2-22, height*0.59, width/2+48, height*0.6, width/2+61, height*0.63, 3, 80]
                        ]],
                        [width/2-41, height*0.41, width/2-37, height*0.36, width/2-34, height*0.32, 3, 40],
                        [width/2-36, height*0.58, width/2-113, height*0.36, width/2-128, height*0.36, 9, 80, [
                            [width/2-73, height*0.42, width/2-117, height*0.37, width/2-129, height*0.3, 2, 40],
                            [width/2-52, height*0.51, width/2-115, height*0.46, width/2-155, height*0.49, 4, 60]
                        ]],
                        [width/2-36, height*0.53, width/2+28, height*0.37, width/2+98, height*0.33, 6, 100, [
                            [width/2-10, height*0.43, width/2+46, height*0.41, width/2+48, height*0.4, 2, 80]
                        ]]
                    ]]
                ],
                bloom: {
                    num: Math.min(700, width * 0.7),
                    width: width,
                    height: height,
                },
                footer: {
                    width: width,
                    height: 5,
                    speed: 10,
                }
            };

            var tree = new Tree(canvas, width, height, opts);
            var seed = tree.seed;
            var foot = tree.footer;
            
            var seedAnimate = eval(Jscex.compile("async", function () {
                seed.draw();
                $await(Jscex.Async.sleep(100));
                while (seed.canScale()) {
                    seed.scale(0.95);
                    $await(Jscex.Async.sleep(10));
                }
                while (seed.canMove()) {
                    seed.move(0, 2);
                    foot.draw();
                    $await(Jscex.Async.sleep(10));
                }
            }));

            var growAnimate = eval(Jscex.compile("async", function () {
                do {
                    tree.grow();
                    $await(Jscex.Async.sleep(10));
                } while (tree.canGrow());
            }));

            var flowAnimate = eval(Jscex.compile("async", function () {
                do {
                    tree.flower(2);
                    $await(Jscex.Async.sleep(10));
                } while (tree.canFlower());
            }));

            var moveAnimate = eval(Jscex.compile("async", function () {
                tree.snapshot("p1", width*0.22, 0, width*0.55, height);
                while (tree.move("p1", width*0.45, 0)) {
                    foot.draw();
                    $await(Jscex.Async.sleep(10));
                }
                foot.draw();
                tree.snapshot("p2", width*0.45, 0, width*0.55, height);

                canvas.parentNode.style.background = "url(" + tree.toDataURL('image/png') + ")";
                canvas.style.background = "#ffc0cb";
                $await(Jscex.Async.sleep(300));
                canvas.style.background = "none";
            }));

            var jumpAnimate = eval(Jscex.compile("async", function () {
                var ctx = tree.ctx;
                while (true) {
                    tree.ctx.clearRect(0, 0, width, height);
                    tree.jump();
                    foot.draw();
                    $await(Jscex.Async.sleep(25));
                }
            }));

            var textAnimate = eval(Jscex.compile("async", function () {
                var together = new Date();
                together.setFullYear(2024, 4, 24);
                together.setHours(0);
                together.setMinutes(0);
                together.setSeconds(0);
                together.setMilliseconds(0);

                $("#clock-box").fadeIn(500);
                
                while (true) {
                    timeElapse(together);
                    $await(Jscex.Async.sleep(1000));
                }
            }));

            var runAsync = eval(Jscex.compile("async", function () {
                $await(seedAnimate());
                $await(growAnimate());
                $await(flowAnimate());
                $await(moveAnimate());

                textAnimate().start();

                $await(jumpAnimate());
            }));

            runAsync().start();
        }
        
        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            createFloatingHearts();
            document.getElementById('seedContainer').addEventListener('click', startExperience);
            musicControl.addEventListener('click', function() {
                if (audio.paused) {
                    audio.play();
                    musicControl.innerHTML = '<i>ğŸµ</i>';
                } else {
                    audio.pause();
                    musicControl.innerHTML = '<i>ğŸ”‡</i>';
                }
            });
            
            // é€‚é…çª—å£å¤§å°
            window.addEventListener('resize', function() {
                const canvas = document.getElementById('canvas');
                if (canvas) {
                    canvas.width = window.innerWidth;
                    canvas.height = window.innerHeight;
                }
            });
        });
    </script>
</body>
</html>
